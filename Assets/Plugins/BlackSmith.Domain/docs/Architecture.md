# BlackSmith.Domain アーキテクチャ設計

## 概要

BlackSmith.Domain は、ゲームアプリケーションのドメイン層を提供する Unity ライブラリです。\
**ドメイン駆動設計（DDD）**と**クリーンアーキテクチャ**の原則に基づき、ゲームのビジネスロジックを UI や永続化から分離し、\
再利用可能で保守性の高いドメインライブラリとして設計されています。

### 設計目標
- **ドメインロジックの純粋性**: ゲームルールとビジネスロジックの明確な定義
- **ライブラリとしての独立性**: Unity 依存を最小限に抑えた移植可能な設計
- **型安全性**: 強型付けによるコンパイル時エラー検出
- **テスタビリティ**: 単体テスト可能なドメイン設計

## アーキテクチャ構造

### レイヤー構成

ライブラリは以下の3層構造で構成されています：

#### 1. Domain層
**責務**: ゲームのコアビジネスロジックとルールの定義
- エンティティ・値オブジェクトによるドメインモデル
- ドメインサービスによるビジネスルール実装
- ゲーム固有の制約と不変条件の保証

#### 2. Usecase層  
**責務**: ドメインロジックの統合とアプリケーション向けサービス提供
- 複数ドメインをまたがる処理の調整
- 外部システムとの境界定義（リポジトリインターフェース）
- トランザクション境界の管理

#### 3. Test層
**責務**: ドメインロジックの品質保証
- 単体テストによるビジネスルール検証
- ドメインモデルの不変条件テスト

### ドメイン構成

ゲームドメインを7つのコアドメインに分割し、それぞれが特定のゲーム要素を管理します：

```
Domain/
├── Character/         # キャラクター成長とステータス管理
├── Item/              # アイテム定義と装備システム
├── Inventory/         # アイテム所有と通貨管理
├── Field/             # 世界構造とフィールド階層
├── Skill/             # スキルと熟練度システム
├── PassiveEffect/     # ステータス効果と一時的変更
└── Quest/             # クエスト基本情報管理
```

各ドメインの詳細実装については [domains/](./domains/) ディレクトリを参照してください。

## 設計原則

### 採用している主要パターン

#### ドメインモデリング
- **値オブジェクト**: record型による不変性とビジネス制約の表現
- **エンティティ**: 一意性を持つゲームオブジェクトの表現
- **ドメインサービス**: エンティティに属さないゲームルールの実装

#### オブジェクト生成
- **ファクトリーパターン**: 複雑なエンティティ生成ロジックのカプセル化
- **コマンドパターン**: エンティティ再構築とパラメータ転送

#### 永続化抽象
- **リポジトリパターン**: データ永続化の抽象化とドメイン層の独立性維持

### SOLID原則の適用
- **単一責任**: 各クラスは単一のゲーム要素を管理
- **開放閉鎖**: 新しいアイテムタイプやスキルの追加が既存コードを変更せずに可能
- **依存性逆転**: ドメイン層は外部システムに依存しない

## 品質特性への対応

### パフォーマンス
- **非同期処理**: UniTaskによる効率的な非同期ゲームロジック
- **イミュータブル設計**: 状態変更の予測可能性とスレッドセーフティ
- **効率的なコレクション**: ImmutableArrayによるメモリ効率

### セキュリティと堅牢性
- **不変性の保証**: record型とprivateコンストラクタによる状態保護
- **入力検証**: ドメインモデルレベルでのビジネスルール検証
- **カプセル化**: 内部状態の隠蔽と制御されたアクセス

### 拡張性
- **オープン/クローズド原則**: 新しいゲーム要素の追加が容易
- **戦略パターン**: ゲームルールの切り替え可能な実装
- **プラグイン可能**: インターフェース経由での機能拡張

## 技術スタック

### Unity環境
- **対象バージョン**: Unity 2023.2 以降
- **C#バージョン**: C# 9.0 (record型、パターンマッチング使用)
- **Null許容参照型**: 有効化 (#nullable enable)

### 依存ライブラリ
- **UniTask 2.5.5**: 効率的な非同期処理とゲームループ統合
- **R3 1.2.8**: リアクティブエクステンションによるイベント処理
- **Newtonsoft.Json 3.2.1**: ドメインオブジェクトのシリアライゼーション
- **System.Collections.Immutable**: 不変コレクションによる安全な状態管理

## ライブラリ利用ガイド

### インストール

Unity Package Manager を使用してインストール:
```
https://github.com/Kojima-Tatsuki/BlackSmith.Domain.git?path=Assets/Plugins/BlackSmith.Domain
```

### 基本的な利用フロー

1. **ドメインサービスの利用**
   - 各種Usecaseクラスを通じてドメインロジックにアクセス
   - リポジトリインターフェースの実装を提供

2. **ドメインイベントの購読**
   - R3のObservableを通じてゲームイベントを監視
   - UI層やエフェクト層との疎結合な連携

3. **カスタマイズポイント**
   - リポジトリ実装によるデータ永続化
   - ドメインサービスの拡張

### アセンブリ構成
- **BlackSmith.Domain.asmdef**: メインドメインライブラリ
- **BlackSmith.Domain.Test.asmdef**: テストアセンブリ

## 関連ドキュメント

### 実装詳細
- **[domains/](./domains/)**: 各ドメインの詳細仕様と実装
- **[systems/](./systems/)**: ドメインサービスの仕様
- **[integration/](./integration/)**: ドメイン間の技術的連携

### プロジェクト情報
- **[CLAUDE.md](../../../../CLAUDE.md)**: プロジェクト全体の設定とルール
- **[README.md](./README.md)**: ドキュメント構成ガイド

BlackSmith.Domain は、ゲームロジックの中核を担う堅牢なドメインライブラリとして、\
型安全で保守性の高いゲーム開発を支援します。